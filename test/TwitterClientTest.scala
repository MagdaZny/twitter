package app

import app.helpers.{ClientParameters, Test}
import com.github.tomakehurst.wiremock.WireMockServer
import com.github.tomakehurst.wiremock.client.WireMock._
import services.TwitterClient

class TwitterClientTest extends Test with ClientParameters {
  import scala.concurrent.ExecutionContext.Implicits.global

  val wireMockServer = new WireMockServer()
  val twitterResponse = "[{\"created_at\":\"Fri Feb 23 22:34:37 +0000 2018\",\"id\":967165828490842112,\"id_str\":\"967165828490842112\",\"text\":\"Announcing a new API status page -&gt; https:\\/\\/t.co\\/VHjrLJJPHO\",\"truncated\":false,\"entities\":{\"hashtags\":[],\"symbols\":[],\"user_mentions\":[],\"urls\":[{\"url\":\"https:\\/\\/t.co\\/VHjrLJJPHO\",\"expanded_url\":\"https:\\/\\/api.twitterstat.us\\/\",\"display_url\":\"api.twitterstat.us\",\"indices\":[39,62]}]},\"source\":\"\\u003ca href=\\\"http:\\/\\/twitter.com\\\" rel=\\\"nofollow\\\"\\u003eTwitter for  iPhone\\u003c\\/a\\u003e\",\"in_reply_to_status_id\":null,\"in_reply_to_status_id_str\":null,\"in_reply_to_user_id\":null,\"in_reply_to_user_id_str\":null,\"in_reply_to_screen_name\":null,\"user\":{\"id\":6253282,\"id_str\":\"6253282\",\"name\":\"Twitter API\",\"screen_name\":\"TwitterAPI\",\"location\":\"San Francisco, CA\",\"description\":\"The Real Twitter API. Tweets about API changes, service issues and our Developer Platform. Don't get an answer? It's on my website.\",\"url\":\"https:\\/\\/t.co\\/8IkCzCDr19\",\"entities\":{\"url\":{\"urls\":[{\"url\":\"https:\\/\\/t.co\\/8IkCzCDr19\",\"expanded_url\":\"https:\\/\\/developer.twitter.com\",\"display_url\":\"developer.twitter.com\",\"indices\":[0,23]}]},\"description\":{\"urls\":[]}},\"protected\":false,\"followers_count\":6275097,\"friends_count\":11,\"listed_count\":12999,\"created_at\":\"Wed May 23 06:01:13 +0000 2007\",\"favourites_count\":29,\"utc_offset\":-25200,\"time_zone\":\"Pacific Time (US & Canada)\",\"geo_enabled\":false,\"verified\":true,\"statuses_count\":3616,\"lang\":\"en\",\"contributors_enabled\":false,\"is_translator\":false,\"is_translation_enabled\":false,\"profile_background_color\":\"C0DEED\",\"profile_background_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_background_images\\/656927849\\/miyt9dpjz77sc0w3d4vj.png\",\"profile_background_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_background_images\\/656927849\\/miyt9dpjz77sc0w3d4vj.png\",\"profile_background_tile\":true,\"profile_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_images\\/942858479592554497\\/BbazLO9L_normal.jpg\",\"profile_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_images\\/942858479592554497\\/BbazLO9L_normal.jpg\",\"profile_banner_url\":\"https:\\/\\/pbs.twimg.com\\/profile_banners\\/6253282\\/1497491515\",\"profile_link_color\":\"0084B4\",\"profile_sidebar_border_color\":\"C0DEED\",\"profile_sidebar_fill_color\":\"DDEEF6\",\"profile_text_color\":\"333333\",\"profile_use_background_image\":true,\"has_extended_profile\":true,\"default_profile\":false,\"default_profile_image\":false,\"following\":null,\"follow_request_sent\":null,\"notifications\":null,\"translator_type\":\"regular\"},\"geo\":null,\"coordinates\":null,\"place\":null,\"contributors\":null,\"is_quote_status\":false,\"retweet_count\":70,\"favorite_count\":151,\"favorited\":false,\"retweeted\":false,\"possibly_sensitive\":false,\"lang\":\"en\"},{\"created_at\":\"Thu Feb 22 22:13:02 +0000 2018\",\"id\":966798009852768257,\"id_str\":\"966798009852768257\",\"text\":\"RT @TwitterDev: We\\u2019re excited to announce a change to Direct Message rate limits that gives those using the APIs the ability to respond to\\u2026\",\"truncated\":false,\"entities\":{\"hashtags\":[],\"symbols\":[],\"user_mentions\":[{\"screen_name\":\"TwitterDev\",\"name\":\"Twitter Dev\",\"id\":2244994945,\"id_str\":\"2244994945\",\"indices\":[3,14]}],\"urls\":[]},\"source\":\"\\u003ca href=\\\"http:\\/\\/twitter.com\\\" rel=\\\"nofollow\\\"\\u003eTwitter Web Client\\u003c\\/a\\u003e\",\"in_reply_to_status_id\":null,\"in_reply_to_status_id_str\":null,\"in_reply_to_user_id\":null,\"in_reply_to_user_id_str\":null,\"in_reply_to_screen_name\":null,\"user\":{\"id\":6253282,\"id_str\":\"6253282\",\"name\":\"Twitter API\",\"screen_name\":\"TwitterAPI\",\"location\":\"San Francisco, CA\",\"description\":\"The Real Twitter API. Tweets about API changes, service issues and our Developer Platform. Don't get an answer? It's on my website.\",\"url\":\"https:\\/\\/t.co\\/8IkCzCDr19\",\"entities\":{\"url\":{\"urls\":[{\"url\":\"https:\\/\\/t.co\\/8IkCzCDr19\",\"expanded_url\":\"https:\\/\\/developer.twitter.com\",\"display_url\":\"developer.twitter.com\",\"indices\":[0,23]}]},\"description\":{\"urls\":[]}},\"protected\":false,\"followers_count\":6275097,\"friends_count\":11,\"listed_count\":12999,\"created_at\":\"Wed May 23 06:01:13 +0000 2007\",\"favourites_count\":29,\"utc_offset\":-25200,\"time_zone\":\"Pacific Time (US & Canada)\",\"geo_enabled\":false,\"verified\":true,\"statuses_count\":3616,\"lang\":\"en\",\"contributors_enabled\":false,\"is_translator\":false,\"is_translation_enabled\":false,\"profile_background_color\":\"C0DEED\",\"profile_background_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_background_images\\/656927849\\/miyt9dpjz77sc0w3d4vj.png\",\"profile_background_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_background_images\\/656927849\\/miyt9dpjz77sc0w3d4vj.png\",\"profile_background_tile\":true,\"profile_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_images\\/942858479592554497\\/BbazLO9L_normal.jpg\",\"profile_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_images\\/942858479592554497\\/BbazLO9L_normal.jpg\",\"profile_banner_url\":\"https:\\/\\/pbs.twimg.com\\/profile_banners\\/6253282\\/1497491515\",\"profile_link_color\":\"0084B4\",\"profile_sidebar_border_color\":\"C0DEED\",\"profile_sidebar_fill_color\":\"DDEEF6\",\"profile_text_color\":\"333333\",\"profile_use_background_image\":true,\"has_extended_profile\":true,\"default_profile\":false,\"default_profile_image\":false,\"following\":null,\"follow_request_sent\":null,\"notifications\":null,\"translator_type\":\"regular\"},\"geo\":null,\"coordinates\":null,\"place\":null,\"contributors\":null,\"retweeted_status\":{\"created_at\":\"Thu Feb 22 22:11:33 +0000 2018\",\"id\":966797637444804608,\"id_str\":\"966797637444804608\",\"text\":\"We\\u2019re excited to announce a change to Direct Message rate limits that gives those using the APIs the ability to res\\u2026 https:\\/\\/t.co\\/sMJvPcE2NM\",\"truncated\":true,\"entities\":{\"hashtags\":[],\"symbols\":[],\"user_mentions\":[],\"urls\":[{\"url\":\"https:\\/\\/t.co\\/sMJvPcE2NM\",\"expanded_url\":\"https:\\/\\/twitter.com\\/i\\/web\\/status\\/966797637444804608\",\"display_url\":\"twitter.com\\/i\\/web\\/status\\/9\\u2026\",\"indices\":[117,140]}]},\"source\":\"\\u003ca href=\\\"http:\\/\\/twitter.com\\\" rel=\\\"nofollow\\\"\\u003eTwitter Web Client\\u003c\\/a\\u003e\",\"in_reply_to_status_id\":null,\"in_reply_to_status_id_str\":null,\"in_reply_to_user_id\":null,\"in_reply_to_user_id_str\":null,\"in_reply_to_screen_name\":null,\"user\":{\"id\":2244994945,\"id_str\":\"2244994945\",\"name\":\"Twitter Dev\",\"screen_name\":\"TwitterDev\",\"location\":\"Internet\",\"description\":\"Your official source for Twitter Platform news, updates & events. Need technical help? Visit https:\\/\\/t.co\\/mGHnxZU8c1 \\u2328\\ufe0f #TapIntoTwitter\",\"url\":\"https:\\/\\/t.co\\/FGl7VOULyL\",\"entities\":{\"url\":{\"urls\":[{\"url\":\"https:\\/\\/t.co\\/FGl7VOULyL\",\"expanded_url\":\"https:\\/\\/developer.twitter.com\\/\",\"display_url\":\"developer.twitter.com\",\"indices\":[0,23]}]},\"description\":{\"urls\":[{\"url\":\"https:\\/\\/t.co\\/mGHnxZU8c1\",\"expanded_url\":\"https:\\/\\/twittercommunity.com\\/\",\"display_url\":\"twittercommunity.com\",\"indices\":[93,116]}]}},\"protected\":false,\"followers_count\":495191,\"friends_count\":1487,\"listed_count\":1316,\"created_at\":\"Sat Dec 14 04:35:55 +0000 2013\",\"favourites_count\":2208,\"utc_offset\":-25200,\"time_zone\":\"Pacific Time (US & Canada)\",\"geo_enabled\":true,\"verified\":true,\"statuses_count\":3322,\"lang\":\"en\",\"contributors_enabled\":false,\"is_translator\":false,\"is_translation_enabled\":false,\"profile_background_color\":\"FFFFFF\",\"profile_background_image_url\":\"http:\\/\\/abs.twimg.com\\/images\\/themes\\/theme1\\/bg.png\",\"profile_background_image_url_https\":\"https:\\/\\/abs.twimg.com\\/images\\/themes\\/theme1\\/bg.png\",\"profile_background_tile\":false,\"profile_image_url\":\"http:\\/\\/pbs.twimg.com\\/profile_images\\/880136122604507136\\/xHrnqf1T_normal.jpg\",\"profile_image_url_https\":\"https:\\/\\/pbs.twimg.com\\/profile_images\\/880136122604507136\\/xHrnqf1T_normal.jpg\",\"profile_banner_url\":\"https:\\/\\/pbs.twimg.com\\/profile_banners\\/2244994945\\/1498675817\",\"profile_link_color\":\"0084B4\",\"profile_sidebar_border_color\":\"FFFFFF\",\"profile_sidebar_fill_color\":\"DDEEF6\",\"profile_text_color\":\"333333\",\"profile_use_background_image\":false,\"has_extended_profile\":true,\"default_profile\":false,\"default_profile_image\":false,\"following\":null,\"follow_request_sent\":null,\"notifications\":null,\"translator_type\":\"regular\"},\"geo\":null,\"coordinates\":null,\"place\":null,\"contributors\":null,\"is_quote_status\":false,\"retweet_count\":55,\"favorite_count\":131,\"favorited\":false,\"retweeted\":false,\"possibly_sensitive\":false,\"lang\":\"en\"},\"is_quote_status\":false,\"retweet_count\":55,\"favorite_count\":0,\"favorited\":false,\"retweeted\":false,\"lang\":\"en\"}]"

  override def beforeEach {
    wireMockServer.start()

  }
  override def afterEach {
    wireMockServer.stop()
  }

  "TwitterClient" should {
    "return a string if call was successfull" in {

      val user = randomString()
      val numberOfTwitts = randomNumber()
      val token = randomString(30)
      val expectedTwitts = Right(Seq("Announcing a new API status page -&gt; https://t.co/VHjrLJJPHO", "RT @TwitterDev: We’re excited to announce a change to Direct Message rate limits that gives those using the APIs the ability to respond to…", "We’re excited to announce a change to Direct Message rate limits that gives those using the APIs the ability to res… https://t.co/sMJvPcE2NM"))
      val client = TwitterClient("http://localhost:8080", token)
      val path = s"/1.1/statuses/user_timeline.json?screen_name=$user&count=$numberOfTwitts"

      stubFor(get(urlEqualTo(path))
        .willReturn(
          aResponse()
            .withStatus(200)
            .withBody(twitterResponse)))

      client.call(user, numberOfTwitts)  should be(expectedTwitts)
    }
  }
}
